<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô | AI Robot Guide ‡∏ô‡πà‡∏≤‡∏ô</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="assets/styles/main.css">
    <link rel="stylesheet" href="assets/styles/alert.css">

    <style>
        /* Page-specific overrides */
        body {
            margin: 0;
            font-family: 'Kanit', sans-serif;
        }

        .page-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-link {
            color: #aaa;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #fff;
        }
    </style>
</head>

<body class="alerts-page">
    <div class="page-container">
        <!-- Back Link -->
        <a href="/" class="back-link">
            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </a>

        <!-- Header -->
        <header class="alerts-header">
            <h1 class="alerts-title">
                üîî ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            </h1>

            <div class="alerts-controls">
                <div class="connection-status disconnected">
                    <span class="connection-status-dot"></span>
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
                </div>

                <button class="alerts-btn secondary" onclick="refreshAlerts()">
                    üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                </button>

                <button class="alerts-btn primary" onclick="testAlert()">
                    üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                </button>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="alerts-stats">
            <div class="stat-card">
                <div class="stat-value stat-total">0</div>
                <div class="stat-label">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>

            <div class="stat-card">
                <div class="stat-value stat-critical">0</div>
                <div class="stat-label">‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (Severity ‚â• 4)</div>
            </div>

            <div class="stat-card">
                <div class="stat-value stat-connections">-</div>
                <div class="stat-label">‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
            </div>

            <div class="stat-card">
                <div class="stat-value stat-scheduler">-</div>
                <div class="stat-label">Scheduler</div>
            </div>
        </div>

        <!-- Scheduler Controls -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="alerts-btn secondary" onclick="startScheduler()">
                ‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏° Scheduler
            </button>
            <button class="alerts-btn secondary" onclick="stopScheduler()">
                ‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î Scheduler
            </button>
            <button class="alerts-btn secondary" onclick="pollNow()">
                üì∞ ‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            </button>
        </div>

        <!-- Alert List -->
        <div class="alerts-list">
            <div class="alerts-empty">
                <div class="alerts-empty-icon">üîî</div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="assets/scripts/config.js"></script>
    <script src="assets/scripts/alert_handler.js"></script>

    <script>
        // Page-specific functions

        async function refreshAlerts() {
            try {
                // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å MongoDB ‡πÅ‡∏ó‡∏ô in-memory
                const res = await fetch(`${window.API_BASE_URL}/api/alerts/db/recent?limit=50`);
                const data = await res.json();

                if (data.success && data.alerts) {
                    window.alertHandler.alerts = data.alerts;
                    window.alertHandler.updateDashboard();
                }
            } catch (e) {
                console.error('Refresh error:', e);
            }
        }

        async function testAlert() {
            try {
                const res = await fetch(`${window.API_BASE_URL}/api/alerts/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        severity: 4,
                        summary: '‚ö†Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô - ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
                        category: 'general',
                        location_name: '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡πà‡∏≤‡∏ô'
                    })
                });
                const data = await res.json();
                console.log('Test alert sent:', data);
            } catch (e) {
                console.error('Test alert error:', e);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á test alert ‡πÑ‡∏î‡πâ');
            }
        }

        async function getStats() {
            try {
                // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏≤‡∏Å MongoDB
                const res = await fetch(`${window.API_BASE_URL}/api/alerts/db/stats`);
                const data = await res.json();

                if (data.success && data.stats) {
                    document.querySelector('.stat-total').textContent = data.stats.total_alerts || 0;
                    document.querySelector('.stat-critical').textContent = data.stats.critical_alerts || 0;
                    document.querySelector('.stat-connections').textContent = data.stats.active_connections || 0;
                    document.querySelector('.stat-scheduler').textContent =
                        data.stats.scheduler_running ? 'üü¢ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : 'üî¥ ‡∏´‡∏¢‡∏∏‡∏î';
                }
            } catch (e) {
                console.error('Stats error:', e);
            }
        }

        async function startScheduler() {
            try {
                const res = await fetch(`${window.API_BASE_URL}/api/alerts/scheduler/start`, { method: 'POST' });
                const data = await res.json();
                alert(data.message);
                getStats();
            } catch (e) {
                console.error('Start scheduler error:', e);
            }
        }

        async function stopScheduler() {
            try {
                const res = await fetch(`${window.API_BASE_URL}/api/alerts/scheduler/stop`, { method: 'POST' });
                const data = await res.json();
                alert(data.message);
                getStats();
            } catch (e) {
                console.error('Stop scheduler error:', e);
            }
        }

        async function pollNow() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß...';

                const res = await fetch(`${window.API_BASE_URL}/api/alerts/poll-now`, { method: 'POST' });
                const data = await res.json();

                alert(`‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ${data.alerts?.length || 0} alerts`);
                refreshAlerts();

                btn.disabled = false;
                btn.textContent = 'üì∞ ‡∏î‡∏∂‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ';
            } catch (e) {
                console.error('Poll now error:', e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                refreshAlerts();
                getStats();
            }, 1000);

            // Refresh stats every 30 seconds
            setInterval(getStats, 30000);
        });
    </script>
</body>

</html>