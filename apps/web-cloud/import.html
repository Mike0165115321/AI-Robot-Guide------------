<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Import - AI Guide ‡∏ô‡πà‡∏≤‡∏ô</title>
    <link rel="stylesheet" href="assets/styles/main.css">
    <link rel="stylesheet" href="assets/styles/admin.css">
    <style>
        /* Import Page Specific Styles */
        .import-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .step.completed {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step.active .step-number {
            background: rgba(255, 255, 255, 0.2);
        }

        .upload-zone {
            border: 2px dashed rgba(102, 126, 234, 0.5);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .preview-section {
            display: none;
            margin-top: 2rem;
        }

        .preview-section.active {
            display: block;
        }

        .preview-table-container {
            overflow-x: auto;
            max-height: 400px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .preview-table th,
        .preview-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
        }

        .preview-table th {
            background: rgba(102, 126, 234, 0.2);
            position: sticky;
            top: 0;
            font-weight: 600;
        }

        .preview-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .fields-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .field-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }

        .field-checkbox:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .field-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
        }

        .field-info {
            flex: 1;
        }

        .field-label {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .field-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-large {
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .file-info .icon {
            font-size: 2rem;
        }

        .file-name {
            font-weight: 600;
        }

        .file-stats {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .comparison-panel {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
        }

        .comparison-panel h4 {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .select-all-container {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Field Group Sections */
        .field-group {
            margin-bottom: 2rem;
        }

        .field-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .field-group-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
        }

        .field-group-title.details {
            color: #11998e;
        }

        .field-group-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        /* Required field indicator */
        .required-indicator {
            color: #ff6b6b;
            margin-left: 4px;
        }

        /* Field type badge */
        .field-type-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            margin-left: 8px;
        }

        .field-type-badge.detail {
            background: rgba(17, 153, 142, 0.2);
            color: #11998e;
        }

        /* Custom Field Section */
        .custom-field-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 12px;
            border: 1px dashed rgba(255, 193, 7, 0.5);
        }

        .custom-field-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: flex-end;
        }

        .custom-field-row input {
            flex: 1;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
        }

        .btn-add-field {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #000;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .custom-fields-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .custom-field-tag {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 193, 7, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }

        .custom-field-tag .remove-btn {
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }

        /* Input Mode Tabs */
        .input-mode-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
        }

        .mode-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .mode-tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .mode-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-tab.active.manual {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        /* Manual Entry Form */
        .manual-entry-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row.full-width {
            grid-template-columns: 1fr;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .form-group label .required {
            color: #ff6b6b;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group .hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* AI Toggle Switch */
        .ai-toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 32px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #444;
            transition: 0.3s;
            border-radius: 32px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(28px);
        }

        .toggle-label {
            font-weight: 600;
        }

        .toggle-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .ai-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .ai-status.on {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .ai-status.off {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
    </style>
</head>

<body>
    <div class="bg-grid"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>

    <div class="import-container">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h1 class="text-gradient">üì• Bulk Import</h1>
                <p style="color: var(--text-muted);">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel/CSV ‡∏î‡πâ‡∏ß‡∏¢ AI ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
            </div>
            <a href="admin.html" class="btn btn-submit"
                style="text-decoration: none; background-color: #667eea; border: none;">
                ‚Üê ‡∏Å‡∏•‡∏±‡∏ö Admin Panel
            </a>
        </header>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step-1">
                <span class="step-number">1</span>
                <span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</span>
            </div>
            <div class="step" id="step-2">
                <span class="step-number">2</span>
                <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Fields</span>
            </div>
            <div class="step" id="step-3">
                <span class="step-number">3</span>
                <span>AI Transform</span>
            </div>
            <div class="step" id="step-4">
                <span class="step-number">4</span>
                <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </div>
        </div>

        <section id="section-upload" class="form-container">
            <h2>üì• Step 1: ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
            <p style="margin-bottom: 1rem;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</p>

            <!-- Input Mode Tabs -->
            <div class="input-mode-tabs">
                <button class="mode-tab active" id="tab-upload" onclick="switchInputMode('upload')">
                    üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
                </button>
                <button class="mode-tab" id="tab-document" onclick="switchInputMode('document')">
                    üìÑ PDF/‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                </button>
                <button class="mode-tab manual" id="tab-manual" onclick="switchInputMode('manual')">
                    ‚úèÔ∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á
                </button>
            </div>

            <!-- Upload Mode Content -->
            <div class="mode-content active" id="mode-upload">
                <p style="margin-bottom: 1rem;">
                    ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx, .xls) ‡πÅ‡∏•‡∏∞ CSV (.csv) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å
                </p>

                <div class="upload-zone" id="upload-zone">
                    <input type="file" id="file-input" accept=".xlsx,.xls,.csv">
                    <div class="upload-icon">üìÅ</div>
                    <p><strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</strong> ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                    <p style="color: var(--text-muted); font-size: 0.9rem;">
                        ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2GB
                    </p>
                </div>

                <div id="file-info-display" style="display: none;" class="file-info">
                    <span class="icon">üìä</span>
                    <div>
                        <div class="file-name" id="uploaded-filename">-</div>
                        <div class="file-stats" id="uploaded-stats">-</div>
                    </div>
                    <button class="btn" style="margin-left: auto;" onclick="resetUpload()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå</button>
                </div>
            </div>

            <!-- Document Import Mode Content -->
            <div class="mode-content" id="mode-document">
                <p style="margin-bottom: 1rem;">
                    ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF ‡∏´‡∏£‡∏∑‡∏≠ DOC/DOCX ‚Üí AI ‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                </p>

                <!-- Entry Count Input - BEFORE Upload -->
                <div class="info-box"
                    style="margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <label style="font-weight: 600;">üéØ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠?</label>
                    <input type="number" id="doc-target-count" min="1" max="50" value="5"
                        style="width: 70px; padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; color: white; text-align: center; font-size: 1rem;">
                    <span style="color: var(--text-muted); font-size: 0.9rem;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (AI ‡∏à‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏µ‡πâ)</span>
                </div>

                <div class="upload-zone" id="doc-upload-zone"
                    onclick="document.getElementById('doc-file-input').click()"
                    style="background: linear-gradient(135deg, rgba(240, 147, 251, 0.1) 0%, rgba(245, 87, 108, 0.1) 100%); cursor: pointer;">
                    <input type="file" id="doc-file-input" accept=".pdf,.doc,.docx"
                        onchange="handleDocumentUpload(event)" style="display: none;">
                    <div class="upload-icon">üìÑ</div>
                    <p><strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF ‡∏´‡∏£‡∏∑‡∏≠ Word</strong></p>
                    <p style="color: var(--text-muted); font-size: 0.9rem;">
                        AI ‡∏à‡∏∞‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    </p>
                </div>

                <!-- Document Scan Results -->
                <div id="doc-scan-results" style="display: none; margin-top: 1.5rem;">
                    <div class="info-box success"
                        style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <p><strong>üìÑ <span id="doc-page-count">0</span> ‡∏´‡∏ô‡πâ‡∏≤</strong> ‚Üí AI ‡∏™‡∏£‡πâ‡∏≤‡∏á <strong><span
                                    id="doc-entry-count">0</span></strong> ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
                            <button type="button" class="btn" onclick="rescanDocumentWithCount()"
                                style="background: rgba(102, 126, 234, 0.3); padding: 0.25rem 0.75rem; font-size: 0.85rem; margin-left: 0.5rem;">
                                üîÑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà
                            </button>
                        </p>
                    </div>

                    <h4 style="margin: 1rem 0;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</h4>
                    <div id="doc-entries-list"
                        style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 400px; overflow-y: auto;">
                        <!-- Entries will be loaded here -->
                    </div>

                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button type="button" class="btn" onclick="addNewDocEntry()"
                            style="background: rgba(102, 126, 234, 0.2);">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </button>
                    </div>

                    <div class="action-buttons" style="margin-top: 1.5rem;">
                        <button type="button" class="btn btn-cta" onclick="goToDocStep2()">
                            ‚è≠Ô∏è ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Fields
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manual Entry Mode Content -->
            <div class="mode-content" id="mode-manual">
                <p style="margin-bottom: 1.5rem;">
                    ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå
                </p>

                <form class="manual-entry-form" id="manual-entry-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Title (‡∏ä‡∏∑‡πà‡∏≠) <span class="required">*</span></label>
                            <input type="text" id="manual-title" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏î‡∏†‡∏π‡∏°‡∏¥‡∏ô‡∏ó‡∏£‡πå">
                        </div>
                        <div class="form-group">
                            <label>Category (‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà) <span class="required">*</span></label>
                            <select id="manual-category" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                                <option value="‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</option>
                                <option value="‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                <option value="‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å">‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</option>
                                <option value="‡∏ß‡∏±‡∏î">‡∏ß‡∏±‡∏î</option>
                                <option value="‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà">‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà</option>
                                <option value="‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</option>
                                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Topic (‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢) <span class="required">*</span></label>
                            <input type="text" id="manual-topic" required
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå, ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠">
                        </div>
                        <div class="form-group">
                            <label>Keywords (‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</label>
                            <input type="text" id="manual-keywords" placeholder="‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma ‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏î,‡∏ô‡πà‡∏≤‡∏ô,‡∏à‡∏¥‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏°">
                            <div class="hint">‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏≥ ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ comma</div>
                        </div>
                    </div>

                    <div class="form-row full-width">
                        <div class="form-group">
                            <label>Summary (‡∏™‡∏£‡∏∏‡∏õ)</label>
                            <textarea id="manual-summary"
                                placeholder="‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ô 2-3 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ"></textarea>
                        </div>
                    </div>

                    <div class="form-row full-width">
                        <div class="form-group">
                            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                            <textarea id="manual-details" rows="4" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á, ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î, ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡∏Ø‡∏•‡∏Ø

AI ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"></textarea>
                        </div>
                    </div>

                    <!-- AI Assist Buttons -->
                    <div class="ai-assist-buttons"
                        style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button type="button" class="btn"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                            onclick="triggerPDFUpload()">
                            üìÑ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF
                        </button>
                        <button type="button" class="btn"
                            style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"
                            onclick="aiWebSearch()">
                            üåê ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö
                        </button>
                    </div>
                    <input type="file" id="pdf-file-input" accept=".pdf" style="display: none;"
                        onchange="handlePDFUpload(event)">

                    <div class="action-buttons" style="justify-content: flex-start;">
                        <button type="button" class="btn btn-cta btn-large" onclick="submitManualEntry()">
                            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button type="reset" class="btn btn-large">
                            üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Step 2: Preview + Select Fields -->
        <section id="section-preview" class="preview-section form-container">
            <h2>üëÅÔ∏è Step 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö & ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Fields</h2>

            <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ:</h3>
            <div class="preview-table-container">
                <table class="preview-table" id="raw-preview-table">
                    <thead id="raw-preview-thead"></thead>
                    <tbody id="raw-preview-tbody"></tbody>
                </table>
            </div>

            <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 2rem 0;">

            <!-- AI Toggle Switch -->
            <div class="ai-toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="ai-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <div>
                    <div class="toggle-label">ü§ñ ‡πÉ‡∏ä‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢ Extract ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    <div class="toggle-desc">‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ API quota)</div>
                </div>
                <span id="ai-status-badge" class="ai-status on">AI ‡πÄ‡∏õ‡∏¥‡∏î</span>
            </div>

            <!-- AI Recommendation Hint -->
            <div
                style="background: rgba(102, 126, 234, 0.1); border-left: 4px solid #667eea; padding: 1rem; border-radius: 0 8px 8px 0; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                    <span style="font-size: 1.2rem;">üí°</span>
                    <div style="font-size: 0.9rem; color: var(--text-light);">
                        <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong><br>
                        ‚Ä¢ <strong>‡πÉ‡∏ä‡πâ AI</strong> ‚Üí ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏£‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ Summary, Category) AI
                        ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>
                        ‚Ä¢ <strong>‡∏Ç‡πâ‡∏≤‡∏° AI</strong> ‚Üí ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏° Schema ‡πÅ‡∏•‡πâ‡∏ß (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î quota)
                    </div>
                </div>
            </div>

            <h3 id="field-selection-title">üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Target Fields (AI ‡∏à‡∏∞ extract ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á fields ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ)</h3>

            <div class="select-all-container">
                <input type="checkbox" id="select-all-fields">
                <label for="select-all-fields"><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</strong></label>
                <span id="selected-count" class="field-group-badge">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: 0 fields</span>
            </div>

            <!-- Core Fields Section -->
            <div class="field-group" id="core-fields-group">
                <div class="field-group-header">
                    <span class="field-group-title">üìã ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å (Core Fields)</span>
                    <span class="field-group-badge">‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Database Schema</span>
                </div>
                <div class="fields-selector" id="core-fields-selector">
                    <!-- Core fields will be loaded here -->
                </div>
            </div>

            <!-- Detail Fields Section -->
            <div class="field-group" id="detail-fields-group">
                <div class="field-group-header">
                    <span class="field-group-title details">üìù ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Details)</span>
                    <span class="field-group-badge">‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏ô details[]</span>
                </div>
                <div class="fields-selector" id="detail-fields-selector">
                    <!-- Detail fields will be loaded here -->
                </div>
            </div>

            <!-- Custom Fields Section -->
            <div class="custom-field-section">
                <h4 style="margin-bottom: 1rem;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Custom Field (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô)</h4>
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                    ‡∏™‡∏£‡πâ‡∏≤‡∏á field ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
                </p>
                <div class="custom-field-row">
                    <input type="text" id="custom-field-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Field (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥, ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ)">
                    <button class="btn-add-field" onclick="addCustomField()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° Field</button>
                </div>
                <div class="custom-fields-list" id="custom-fields-list">
                    <!-- Custom fields will appear here -->
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-large" onclick="goToStep(1)">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button class="btn btn-cta btn-large" id="btn-transform" onclick="runAITransform()"
                    style="display: inline-flex;">
                    ü§ñ AI Transform ‚Üí
                </button>
                <button class="btn btn-large" id="btn-skip-ai" onclick="skipAITransform()"
                    style="display: none; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: #000;">
                    ‚è© ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢
                </button>
            </div>
        </section>

        <!-- Step 3: AI Transform Preview -->
        <section id="section-transform" class="preview-section form-container">
            <h2>ü§ñ Step 3: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå AI Transform</h2>
            <p>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö vs ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà AI ‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß</p>

            <div class="preview-table-container" style="max-height: 500px;">
                <table class="preview-table" id="transform-preview-table">
                    <thead id="transform-preview-thead"></thead>
                    <tbody id="transform-preview-tbody"></tbody>
                </table>
            </div>

            <div class="action-buttons">
                <button class="btn btn-large" onclick="goToStep(2)">‚Üê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Fields</button>
                <button class="btn btn-cta btn-large" id="btn-save" onclick="confirmSave()">
                    üíæ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚Üí
                </button>
            </div>
        </section>

        <!-- Step 4: Success -->
        <section id="section-success" class="preview-section form-container" style="text-align: center;">
            <h2>‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
            <p id="success-message">-</p>
            <div class="action-buttons">
                <button class="btn btn-large" onclick="location.reload()">üì• Import ‡∏≠‡∏µ‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
                <a href="admin.html" class="btn btn-cta btn-large" style="text-decoration: none;">
                    üìã ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin
                </a>
            </div>
        </section>
    </div>

    <script src="assets/scripts/config.js"></script>
    <script>
        // ===========================================
        // State Management
        // ===========================================
        let currentStep = 1;
        let rawData = [];
        let transformedData = [];
        let targetFields = [];
        let allFields = [];

        // ===========================================
        // API Base URL
        // ===========================================
        const API_BASE = window.API_BASE_URL || 'http://localhost:9090';

        // ===========================================
        // Input Mode State (upload or manual)
        // ===========================================
        let inputMode = 'upload';

        function switchInputMode(mode) {
            inputMode = mode;

            // Update tabs
            document.getElementById('tab-upload').classList.toggle('active', mode === 'upload');
            document.getElementById('tab-document').classList.toggle('active', mode === 'document');
            document.getElementById('tab-manual').classList.toggle('active', mode === 'manual');

            // Update content visibility
            document.getElementById('mode-upload').classList.toggle('active', mode === 'upload');
            document.getElementById('mode-document').classList.toggle('active', mode === 'document');
            document.getElementById('mode-manual').classList.toggle('active', mode === 'manual');
        }

        // ===========================================
        // AI Toggle State
        // ===========================================
        let useAI = true;  // Default: use AI

        function initAIToggle() {
            const toggle = document.getElementById('ai-toggle');
            const badge = document.getElementById('ai-status-badge');
            const btnTransform = document.getElementById('btn-transform');
            const btnSkipAI = document.getElementById('btn-skip-ai');
            const fieldTitle = document.getElementById('field-selection-title');

            toggle.addEventListener('change', function () {
                useAI = this.checked;

                if (useAI) {
                    badge.textContent = 'AI ‡πÄ‡∏õ‡∏¥‡∏î';
                    badge.className = 'ai-status on';
                    btnTransform.style.display = 'inline-flex';
                    btnSkipAI.style.display = 'none';
                    fieldTitle.textContent = 'üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Target Fields (AI ‡∏à‡∏∞ extract ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á fields ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ)';
                } else {
                    badge.textContent = 'AI ‡∏õ‡∏¥‡∏î';
                    badge.className = 'ai-status off';
                    btnTransform.style.display = 'none';
                    btnSkipAI.style.display = 'inline-flex';
                    fieldTitle.textContent = 'üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Fields ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á)';
                }
            });
        }

        // Skip AI and go directly to manual entry
        function skipAITransform() {
            targetFields = getSelectedFields();

            if (targetFields.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Fields ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 field');
                return;
            }

            // Create empty transformed data from raw data
            transformedData = rawData.map(row => {
                const result = {};
                targetFields.forEach(field => {
                    // Use first raw data value as a hint
                    result[field] = '';
                });
                result['_original_combined'] = Object.values(row).filter(v => v).join(' | ');
                result['_original_row'] = row;
                return result;
            });

            // Show in transform preview with editable note
            renderTransformPreviewTable({ target_fields: targetFields, transformed_rows: transformedData }, true);
            goToStep(3);
        }

        // ===========================================
        // Document Import Mode
        // ===========================================
        let documentText = '';
        let documentEntries = [];
        let uploadedDocFile = null;  // Store for rescan


        async function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const validExts = ['.pdf', '.doc', '.docx'];
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            if (!validExts.includes(ext)) {
                alert('‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå PDF, DOC, DOCX ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }

            // Store file for rescan
            uploadedDocFile = file;

            const targetCount = parseInt(document.getElementById('doc-target-count').value) || 5;

            showLoading('üìÑ AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£...');

            try {
                // First, just do the scan to get entries (for preview)
                const formData = new FormData();
                formData.append('file', file);
                formData.append('target_count', targetCount.toString());

                const response = await fetch(`${API_BASE}/api/admin/import/document-scan`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || '‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }

                if (!result.success || result.entries.length === 0) {
                    alert(result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
                    return;
                }

                // Save data
                documentText = result.text_preview;
                documentEntries = result.entries;

                // Set document mode flag
                window.isDocumentMode = true;

                // Prepare raw data for Step 2 preview
                rawData = documentEntries.map(e => ({ title: e.title, description: e.description }));

                // Render raw preview
                renderRawPreviewTable({
                    columns: ['title', 'description'],
                    preview_rows: rawData
                });

                // Load fields and go to Step 2
                await loadTargetFields();
                goToStep(2);

                alert(`‚úÖ ‡∏û‡∏ö ${result.entries.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Fields ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£`);

            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Function to start streaming extraction (called when user clicks Transform in Step 2)
        async function startDocumentStreaming() {
            if (!uploadedDocFile) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
                return;
            }

            // Get selected fields using shared function
            const selectedFields = getSelectedFields();

            if (selectedFields.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 field');
                return;
            }

            const targetCount = parseInt(document.getElementById('doc-target-count').value) || 5;
            const targetFields = selectedFields.join(',');

            // Go to Step 3 and start streaming
            transformedData = [];
            targetFields_arr = selectedFields;

            renderStreamingPreviewTable(targetFields_arr);
            goToStep(3);

            // Start SSE streaming
            const formData = new FormData();
            formData.append('file', uploadedDocFile);
            formData.append('target_count', targetCount.toString());
            formData.append('target_fields', targetFields);

            try {
                const response = await fetch(`${API_BASE}/api/admin/import/document-stream`, {
                    method: 'POST',
                    body: formData
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const event = JSON.parse(line.slice(6));
                                handleSSEEvent(event);
                            } catch (e) {
                                console.log('SSE parse error:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        let targetFields_arr = [];
        let streamingTotal = 0;
        let streamingCompleted = 0;

        function handleSSEEvent(event) {
            const type = event.type;
            const data = event.data;

            if (type === 'scan') {
                streamingTotal = data.total_entries;
                streamingCompleted = 0;
                updateStreamingProgress();
            } else if (type === 'entry') {
                streamingCompleted++;
                transformedData.push(data);
                addStreamingEntry(data);
                updateStreamingProgress();
            } else if (type === 'done') {
                updateStreamingProgress(true);
            } else if (type === 'error') {
                alert('‚ùå ' + data.message);
            }
        }

        function renderStreamingPreviewTable(fields) {
            const thead = document.getElementById('transform-preview-thead');
            const tbody = document.getElementById('transform-preview-tbody');

            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Header
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>#</th>';
            fields.forEach(field => {
                headerRow.innerHTML += `<th>${field}</th>`;
            });
            thead.appendChild(headerRow);

            // Add progress row
            tbody.innerHTML = `<tr id="streaming-progress-row">
                <td colspan="${fields.length + 1}" style="text-align: center; padding: 2rem;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
                        <div class="loading-spinner" style="width: 30px; height: 30px;"></div>
                        <span id="streaming-status">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span>
                    </div>
                </td>
            </tr>`;
        }

        function addStreamingEntry(data) {
            const tbody = document.getElementById('transform-preview-tbody');
            const progressRow = document.getElementById('streaming-progress-row');

            const tr = document.createElement('tr');
            tr.innerHTML = `<td>‚úÖ ${streamingCompleted}</td>`;
            targetFields_arr.forEach(field => {
                const value = data[field] || '';
                const displayValue = typeof value === 'string' ? value.substring(0, 80) : String(value);
                tr.innerHTML += `<td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(displayValue)}</td>`;
            });

            // Insert before progress row
            tbody.insertBefore(tr, progressRow);
        }

        function updateStreamingProgress(done = false) {
            const statusEl = document.getElementById('streaming-status');
            if (statusEl) {
                if (done) {
                    const progressRow = document.getElementById('streaming-progress-row');
                    if (progressRow) progressRow.remove();
                    statusEl.textContent = `‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ${streamingCompleted} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                } else {
                    statusEl.textContent = `üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•... ${streamingCompleted}/${streamingTotal}`;
                }
            }
        }

        async function rescanDocumentWithCount() {
            if (!uploadedDocFile) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const targetCount = parseInt(document.getElementById('doc-target-count').value) || 5;

            showLoading(`üìÑ AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà (${targetCount} ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)...`);

            try {
                const formData = new FormData();
                formData.append('file', uploadedDocFile);
                formData.append('target_count', targetCount.toString());

                const response = await fetch(`${API_BASE}/api/admin/import/document-scan`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || '‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }

                // Update data
                documentText = result.text_preview;
                documentEntries = result.entries;

                // Update UI
                document.getElementById('doc-page-count').textContent = result.page_count;
                document.getElementById('doc-entry-count').textContent = result.entries.length;
                renderDocumentEntries();

                alert(`‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏û‡∏ö ${result.entries.length} ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠`);

            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function renderDocumentEntries() {
            const container = document.getElementById('doc-entries-list');
            container.innerHTML = documentEntries.map((entry, index) => `
                <div class="entry-item" style="background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">üìå</span>
                    <input type="text" value="${entry.title || ''}" 
                        onchange="updateDocEntry(${index}, 'title', this.value)"
                        style="flex: 1; background: transparent; border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem; border-radius: 4px; color: white;">
                    <input type="text" value="${entry.description || ''}" 
                        onchange="updateDocEntry(${index}, 'description', this.value)"
                        placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢"
                        style="flex: 2; background: transparent; border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem; border-radius: 4px; color: white;">
                    <button onclick="removeDocEntry(${index})" style="background: rgba(255,0,0,0.3); border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; color: white;">üóëÔ∏è</button>
                </div>
            `).join('');
            document.getElementById('doc-entry-count').textContent = documentEntries.length;
        }

        function updateDocEntry(index, field, value) {
            documentEntries[index][field] = value;
        }

        function removeDocEntry(index) {
            documentEntries.splice(index, 1);
            renderDocumentEntries();
        }

        function addNewDocEntry() {
            documentEntries.push({ title: '', description: '' });
            renderDocumentEntries();
            // Focus on new entry
            const inputs = document.querySelectorAll('#doc-entries-list input[type="text"]');
            if (inputs.length > 0) {
                inputs[inputs.length - 2].focus();
            }
        }

        async function goToDocStep2() {
            // Filter out empty entries
            documentEntries = documentEntries.filter(e => e.title && e.title.trim());

            if (documentEntries.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                return;
            }

            // Use the document entries as raw data for Step 2
            rawData = documentEntries.map(e => ({ title: e.title, description: e.description }));

            // Set document mode flag
            window.isDocumentMode = true;
            window.documentTextForExtract = documentText;

            // Render raw preview for document entries
            renderRawPreviewTable({
                columns: ['title', 'description'],
                preview_rows: rawData
            });

            // Load fields and go to Step 2
            await loadTargetFields();
            goToStep(2);
        }

        // ===========================================
        // Step Navigation
        // ===========================================
        function goToStep(step) {
            currentStep = step;
            updateStepIndicators();
            updateSectionVisibility();
        }

        function updateStepIndicators() {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                stepEl.classList.remove('active', 'completed');
                if (i < currentStep) {
                    stepEl.classList.add('completed');
                } else if (i === currentStep) {
                    stepEl.classList.add('active');
                }
            }
        }

        function updateSectionVisibility() {
            document.getElementById('section-upload').style.display = currentStep === 1 ? 'block' : 'none';
            document.getElementById('section-preview').style.display = currentStep === 2 ? 'block' : 'none';
            document.getElementById('section-preview').classList.toggle('active', currentStep === 2);
            document.getElementById('section-transform').style.display = currentStep === 3 ? 'block' : 'none';
            document.getElementById('section-transform').classList.toggle('active', currentStep === 3);
            document.getElementById('section-success').style.display = currentStep === 4 ? 'block' : 'none';
            document.getElementById('section-success').classList.toggle('active', currentStep === 4);
        }

        // ===========================================
        // Loading Overlay
        // ===========================================
        function showLoading(text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }

        // ===========================================
        // Manual Entry Submission (Single Record)
        // ===========================================
        async function submitManualEntry() {
            const title = document.getElementById('manual-title').value.trim();
            const category = document.getElementById('manual-category').value;
            const topic = document.getElementById('manual-topic').value.trim();
            const keywords = document.getElementById('manual-keywords').value.trim();
            const summary = document.getElementById('manual-summary').value.trim();
            const details = document.getElementById('manual-details').value.trim();

            // Validation
            if (!title || !category || !topic) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Title, Category ‡πÅ‡∏•‡∏∞ Topic');
                return;
            }

            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

            try {
                // Generate slug from title
                const slug = title.toLowerCase()
                    .replace(/\s+/g, '-')
                    .replace(/[^\u0E00-\u0E7Fa-z0-9-]/g, '')
                    .substring(0, 50) + '-' + Date.now().toString(36);

                // Build location data
                const locationData = {
                    slug: slug,
                    title: title,
                    category: category,
                    topic: topic,
                    summary: summary || `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ${title}`,
                    keywords: keywords ? keywords.split(',').map(k => k.trim()).filter(k => k) : [title, category, topic],
                    details: details ? [{ heading: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', content: details }] : []
                };

                const response = await fetch(`${API_BASE}/api/admin/locations/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(locationData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }

                // Success
                document.getElementById('success-message').innerHTML =
                    `<strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong><br>` +
                    `‡πÄ‡∏û‡∏¥‡πà‡∏° "${title}" ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`;
                goToStep(4);

                // Reset form
                document.getElementById('manual-entry-form').reset();

            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ===========================================
        // PDF Upload & AI Assist (Manual Entry)
        // ===========================================
        function triggerPDFUpload() {
            document.getElementById('pdf-file-input').click();
        }

        async function handlePDFUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.pdf')) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }

            showLoading('üìÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô PDF ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/api/admin/import/pdf-extract`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || '‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô PDF ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }

                if (!result.success) {
                    alert(result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å PDF ‡πÑ‡∏î‡πâ');
                    return;
                }

                // Fill form with AI extracted data
                console.log('üìÑ PDF API Response:', result);
                console.log('üìÑ AI Data:', result.ai_data);

                if (result.ai_data) {
                    fillFormWithAIData(result.ai_data);
                    alert(`‚úÖ ${result.message}\n\nAI ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£`);
                } else {
                    alert(`‚ö†Ô∏è ${result.message}\n\n‡πÅ‡∏ï‡πà AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ extract ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á`);
                }

            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                hideLoading();
                // Reset file input
                event.target.value = '';
            }
        }

        async function aiWebSearch() {
            // Collect current form data
            const partialData = {
                title: document.getElementById('manual-title').value.trim(),
                category: document.getElementById('manual-category').value,
                topic: document.getElementById('manual-topic').value.trim(),
                keywords: document.getElementById('manual-keywords').value.trim(),
                summary: document.getElementById('manual-summary').value.trim(),
                details: document.getElementById('manual-details').value.trim()
            };

            // Check if there's enough data for web search
            const hasData = partialData.title || partialData.topic;
            if (!hasData) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô\n\nAI ‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ');
                return;
            }

            showLoading('üåê AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö...');

            try {
                const response = await fetch(`${API_BASE}/api/admin/import/ai-fill-form`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        partial_data: partialData,
                        target_fields: ['title', 'category', 'topic', 'summary', 'keywords'],
                        use_web_search: true
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }

                if (result.success && result.filled_data) {
                    fillFormWithAIData(result.filled_data);
                    alert(`‚úÖ ${result.message}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£`);
                } else {
                    alert(result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö');
                }

            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function fillFormWithAIData(data) {
            if (data.title) document.getElementById('manual-title').value = data.title;
            if (data.category) {
                const categorySelect = document.getElementById('manual-category');
                // Try to match category option
                const options = Array.from(categorySelect.options).map(o => o.value);
                if (options.includes(data.category)) {
                    categorySelect.value = data.category;
                } else {
                    // If no exact match, try partial match or default to '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
                    categorySelect.value = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                }
            }
            if (data.topic) document.getElementById('manual-topic').value = data.topic;
            if (data.keywords) {
                const keywordsValue = Array.isArray(data.keywords) ? data.keywords.join(', ') : data.keywords;
                document.getElementById('manual-keywords').value = keywordsValue;
            }
            if (data.summary) document.getElementById('manual-summary').value = data.summary;

            // Combine detail fields into details textarea
            const detailParts = [];
            if (data.detail_overview) detailParts.push(`‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°: ${data.detail_overview}`);
            if (data.detail_location) detailParts.push(`‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á: ${data.detail_location}`);
            if (data.detail_hours_contact) detailParts.push(`‡πÄ‡∏ß‡∏•‡∏≤/‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${data.detail_hours_contact}`);
            if (data.detail_highlights) detailParts.push(`‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô: ${data.detail_highlights}`);
            if (data.detail_price) detailParts.push(`‡∏£‡∏≤‡∏Ñ‡∏≤: ${data.detail_price}`);

            if (detailParts.length > 0) {
                const existingDetails = document.getElementById('manual-details').value.trim();
                const newDetails = detailParts.join('\n\n');
                document.getElementById('manual-details').value = existingDetails
                    ? existingDetails + '\n\n---\n\n' + newDetails
                    : newDetails;
            }
        }

        // ===========================================
        // File Upload Handling
        // ===========================================
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFileUpload(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            // Validate file size (2GB max)
            const MAX_FILE_SIZE = 2 * 1024 * 1024 * 1024; // 2GB
            if (file.size > MAX_FILE_SIZE) {
                alert('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ! ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2GB');
                return;
            }

            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/api/admin/import/preview-raw`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå');
                }

                const result = await response.json();
                rawData = result.preview_rows;

                // Update UI
                document.getElementById('uploaded-filename').textContent = result.filename;
                document.getElementById('uploaded-stats').textContent =
                    `${result.total_rows} ‡πÅ‡∏ñ‡∏ß, ${result.columns.length} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå`;
                document.getElementById('file-info-display').style.display = 'flex';
                uploadZone.style.display = 'none';

                // Render preview table
                renderRawPreviewTable(result);

                // Load target fields
                await loadTargetFields();

                // For Excel/CSV: skip field selection, auto-run AI Transform
                // Auto-select default fields
                const defaultFields = ['title', 'category', 'topic', 'summary', 'keywords'];
                targetFields = defaultFields;

                // Run AI transform automatically
                showLoading('ü§ñ AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

                try {
                    const transformResponse = await fetch(`${API_BASE}/api/admin/import/ai-transform`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            raw_data: rawData,
                            target_fields: targetFields
                        })
                    });

                    if (!transformResponse.ok) {
                        const error = await transformResponse.json();
                        throw new Error(error.detail || 'AI Transform ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                    }

                    const transformResult = await transformResponse.json();
                    transformedData = transformResult.transformed_rows;

                    renderTransformPreviewTable(transformResult);
                    goToStep(3);  // Skip to Step 3 (AI Transform Preview)

                } catch (transformError) {
                    alert('AI Transform error: ' + transformError.message);
                    // Fallback: go to Step 2 for manual field selection
                    goToStep(2);
                }

            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function resetUpload() {
            rawData = [];
            transformedData = [];
            fileInput.value = '';
            document.getElementById('file-info-display').style.display = 'none';
            uploadZone.style.display = 'block';
            goToStep(1);
        }

        // ===========================================
        // Preview Table Rendering
        // ===========================================
        function renderRawPreviewTable(data) {
            const thead = document.getElementById('raw-preview-thead');
            const tbody = document.getElementById('raw-preview-tbody');

            // Clear existing
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Create header row
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>#</th>';
            data.columns.forEach(col => {
                headerRow.innerHTML += `<th>${escapeHtml(col)}</th>`;
            });
            thead.appendChild(headerRow);

            // Create data rows
            data.preview_rows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${idx + 1}</td>`;
                data.columns.forEach(col => {
                    const value = row[col] !== undefined ? row[col] : '';
                    tr.innerHTML += `<td>${escapeHtml(String(value).substring(0, 100))}</td>`;
                });
                tbody.appendChild(tr);
            });
        }

        // ===========================================
        // Target Fields - Grouped Display
        // ===========================================
        let coreFields = [];
        let detailFields = [];
        let customFields = [];  // User-added custom fields

        async function loadTargetFields() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/import/target-fields`);
                const result = await response.json();

                coreFields = result.core_fields || [];
                detailFields = result.detail_fields || [];
                allFields = result.all_fields || [...coreFields, ...detailFields];

                renderGroupedFieldsSelector();
                setupFieldCheckboxListeners();
            } catch (error) {
                console.error('Error loading target fields:', error);
            }
        }

        function renderGroupedFieldsSelector() {
            // Render Core Fields
            const coreContainer = document.getElementById('core-fields-selector');
            coreContainer.innerHTML = '';
            coreFields.forEach(field => {
                coreContainer.appendChild(createFieldCheckbox(field));
            });

            // Render Detail Fields
            const detailContainer = document.getElementById('detail-fields-selector');
            detailContainer.innerHTML = '';
            detailFields.forEach(field => {
                detailContainer.appendChild(createFieldCheckbox(field, true));
            });

            updateSelectedCount();
        }

        function createFieldCheckbox(field, isDetail = false) {
            const div = document.createElement('div');
            div.className = 'field-checkbox';

            const requiredBadge = field.required ? '<span class="required-indicator">*</span>' : '';
            const typeBadge = field.type === 'detail'
                ? '<span class="field-type-badge detail">detail[]</span>'
                : `<span class="field-type-badge">${field.type || 'text'}</span>`;

            div.innerHTML = `
                <input type="checkbox" id="field-${field.key}" value="${field.key}" data-group="${field.group || 'core'}">
                <div class="field-info">
                    <div class="field-label">${field.label}${requiredBadge}${typeBadge}</div>
                    <div class="field-desc">${field.description}</div>
                </div>
            `;
            return div;
        }

        function setupFieldCheckboxListeners() {
            // Select All functionality
            document.getElementById('select-all-fields').addEventListener('change', function () {
                const allCheckboxes = document.querySelectorAll('#core-fields-selector input[type="checkbox"], #detail-fields-selector input[type="checkbox"]');
                allCheckboxes.forEach(cb => cb.checked = this.checked);
                updateSelectedCount();
            });

            // Individual checkbox change
            document.querySelectorAll('#core-fields-selector input, #detail-fields-selector input').forEach(cb => {
                cb.addEventListener('change', updateSelectedCount);
            });
        }

        function updateSelectedCount() {
            const allCheckboxes = document.querySelectorAll('#core-fields-selector input:checked, #detail-fields-selector input:checked');
            const customCount = customFields.length;
            const totalSelected = allCheckboxes.length + customCount;
            document.getElementById('selected-count').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${totalSelected} fields`;
        }

        // ===========================================
        // Custom Fields Management
        // ===========================================
        function addCustomField() {
            const input = document.getElementById('custom-field-name');
            const fieldName = input.value.trim();

            if (!fieldName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ Field');
                return;
            }

            // Create key from name (convert to snake_case)
            const key = 'custom_' + fieldName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_\u0E00-\u0E7F]/g, '');

            // Check for duplicates
            if (customFields.find(f => f.key === key)) {
                alert('Field ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }

            customFields.push({
                key: key,
                label: fieldName,
                description: `Custom field: ${fieldName}`,
                type: 'custom',
                group: 'custom'
            });

            renderCustomFieldsList();
            input.value = '';
            updateSelectedCount();
        }

        function removeCustomField(key) {
            customFields = customFields.filter(f => f.key !== key);
            renderCustomFieldsList();
            updateSelectedCount();
        }

        function renderCustomFieldsList() {
            const container = document.getElementById('custom-fields-list');
            container.innerHTML = '';

            customFields.forEach(field => {
                const tag = document.createElement('div');
                tag.className = 'custom-field-tag';
                tag.innerHTML = `
                    <span>üìå ${field.label}</span>
                    <button class="remove-btn" onclick="removeCustomField('${field.key}')">&times;</button>
                `;
                container.appendChild(tag);
            });
        }

        function getSelectedFields() {
            // Get checked standard fields
            const standardCheckboxes = document.querySelectorAll('#core-fields-selector input:checked, #detail-fields-selector input:checked');
            const selectedKeys = Array.from(standardCheckboxes).map(cb => cb.value);

            // Add all custom fields (they're always included if added)
            customFields.forEach(f => selectedKeys.push(f.key));

            return selectedKeys;
        }

        // ===========================================
        // AI Transform
        // ===========================================
        async function runAITransform() {
            // Document Mode: Delegate to streaming function
            if (window.isDocumentMode) {
                await startDocumentStreaming();
                return;
            }

            // Excel/CSV Mode: Standard flow
            targetFields = getSelectedFields();

            if (targetFields.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Target Fields ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 field');
                return;
            }

            showLoading('ü§ñ AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

            try {
                // Use regular ai-transform API for Excel/CSV
                const response = await fetch(`${API_BASE}/api/admin/import/ai-transform`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raw_data: rawData,
                        target_fields: targetFields
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'AI Transform ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }

                let result = await response.json();
                transformedData = result.transformed_rows;

                renderTransformPreviewTable(result);
                goToStep(3);

            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function renderTransformPreviewTable(data) {
            const thead = document.getElementById('transform-preview-thead');
            const tbody = document.getElementById('transform-preview-tbody');

            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Header with edit indicator
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>#</th><th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö</th>';
            data.target_fields.forEach(field => {
                const fieldInfo = allFields.find(f => f.key === field);
                headerRow.innerHTML += `<th>${fieldInfo ? fieldInfo.label : field} <span style="font-size:0.7rem;color:#667eea;">‚úèÔ∏è</span></th>`;
            });
            thead.appendChild(headerRow);

            // Rows with editable cells
            data.transformed_rows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                const original = row._original_combined || '';
                tr.innerHTML = `<td>${idx + 1}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;" title="${escapeHtml(original)}">${escapeHtml(original.substring(0, 60))}...</td>`;

                data.target_fields.forEach(field => {
                    const value = row[field] || '';
                    const td = document.createElement('td');
                    td.contentEditable = true;
                    td.textContent = String(value);
                    td.dataset.rowIndex = idx;
                    td.dataset.field = field;
                    td.style.cssText = 'background: rgba(102,126,234,0.1); border: 1px solid rgba(102,126,234,0.3); cursor: text; min-width: 100px; padding: 8px;';

                    // Update data on blur
                    td.addEventListener('blur', function () {
                        transformedData[idx][field] = this.textContent.trim();
                        this.style.background = 'rgba(34,197,94,0.2)'; // Show saved
                        setTimeout(() => { this.style.background = 'rgba(102,126,234,0.1)'; }, 500);
                    });

                    // Highlight on focus
                    td.addEventListener('focus', function () {
                        this.style.background = 'rgba(255,255,255,0.15)';
                    });

                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            // Add edit instruction
            const instruction = document.createElement('div');
            instruction.style.cssText = 'margin-top: 1rem; padding: 0.75rem; background: rgba(102,126,234,0.15); border-radius: 8px; font-size: 0.9rem; color: var(--text-light);';
            instruction.innerHTML = 'üí° <strong>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ:</strong> ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
            tbody.parentElement.parentElement.appendChild(instruction);
        }

        // ===========================================
        // Confirm Save
        // ===========================================
        async function confirmSave() {
            if (transformedData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                return;
            }

            showLoading('üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

            try {
                const response = await fetch(`${API_BASE}/api/admin/import/confirm-save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transformed_rows: transformedData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('success-message').textContent =
                        `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${result.saved_count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£! ${result.message}`;
                    goToStep(4);
                } else {
                    throw new Error(result.message || '‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }

            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ===========================================
        // Utilities
        // ===========================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        updateStepIndicators();
        updateSectionVisibility();
        initAIToggle();

        // Check URL params for mode
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'manual') {
            // Auto-turn off AI when coming from manual mode link
            document.getElementById('ai-toggle').checked = false;
            document.getElementById('ai-toggle').dispatchEvent(new Event('change'));
        }
    </script>
</body>

</html>