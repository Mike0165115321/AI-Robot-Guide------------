# üì± ‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE Official Account (LINE Integration Deep Dive)

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ Technical Detail ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á **AI Robot Guide** ‡πÅ‡∏•‡∏∞ **LINE Platform** ‡∏ã‡∏∂‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏à‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏ö‡∏ö Full Loop ‡πÅ‡∏•‡πâ‡∏ß‡∏ú‡πà‡∏≤‡∏ô `worker_line.py`

---

## 1. ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö Asynchronous (Async Architecture)

‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å LINE Webhook ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ HTTP 200 OK **‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ** ‡πÅ‡∏ï‡πà AI (‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Gemini) ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏¥‡∏î‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏£‡∏≤‡∏à‡∏∂‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö **Producer-Consumer** ‡∏ú‡πà‡∏≤‡∏ô Redis Queue

```mermaid
sequenceDiagram
    participant IDP as "LINE Platform"
    participant API as "FastAPI (/webhook)"
    participant Redis as "Redis Queue"
    participant Worker as "Worker (worker_line.py)"
    participant AI as "RAG Orchestrator"
    
    IDP->>API: 1. Webhook Event (User sent message)
    API->>API: 2. Verify Signature & Parse
    API->>Redis: 3. Push Task (LPUSH line_task_queue)
    API-->>IDP: 4. HTTP 200 OK (‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
    
    loop Background Worker
        Worker->>Redis: 5. BRPOP (‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô)
        Redis-->>Worker: 6. ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Message Object
        Worker->>AI: 7. Process Logic (Dual Brain)
        AI-->>Worker: 8. Result (Text + Image URL)
        Worker->>IDP: 9. Reply API (‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå)
    end
```

---

## 2. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Worker (`worker_line.py`)

Worker ‡∏Ñ‡∏∑‡∏≠ Process ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏≤‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö Main Web Server) ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

### 2.1 Initialization
*   ‡πÇ‡∏´‡∏•‡∏î `LINE_CHANNEL_ACCESS_TOKEN` ‡∏à‡∏≤‡∏Å `.env`
*   ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• MongoDB ‡πÅ‡∏•‡∏∞ Qdrant
*   ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° `RAGOrchestrator` ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏ `frontend_intent="LINE"` (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡πà‡∏á Markdown ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)

### 2.2 Message Processing
‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏à‡∏ï‡∏ô‡∏≤ (Intent) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡πÅ‡∏ï‡πà‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏°‡∏≤‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô **Flex Message**

**JSON Logic ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message (`LineMessageBuilder`):**
*   **‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà Text:** ‡∏™‡πà‡∏á `TextSendMessage` ‡∏õ‡∏Å‡∏ï‡∏¥
*   **‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:** ‡∏™‡∏£‡πâ‡∏≤‡∏á **Image Carousel** (‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏°‡∏£‡∏π‡∏õ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤‡πÑ‡∏î‡πâ)
*   **‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏•‡∏á:** ‡∏™‡∏£‡πâ‡∏≤‡∏á **Music Card** ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° Listen (‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube)
*   **‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:** ‡∏™‡∏£‡πâ‡∏≤‡∏á **Location Bubble** ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á" (Google Maps)

---

## 3. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Webhook Security)

‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á API Server (`api/routers/line_webhook.py`) ‡∏°‡∏µ‡∏î‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏Ñ‡∏∑‡∏≠ **Signature Validation**:

```python
# ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Logic ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
signature = request.headers['X-Line-Signature']
body = await request.body()

try:
    handler.handle(body.decode(), signature) # ‡∏ñ‡πâ‡∏≤ Signature ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡∏à‡∏∞ Error ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
except InvalidSignatureError:
    raise HTTPException(status_code=400, detail="Fake Request detected!")
```

*   **X-Line-Signature:** ‡∏Ñ‡∏∑‡∏≠ HMAC-SHA256 ‡∏Ç‡∏≠‡∏á Body ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢ Channel Secret
*   ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Hacker ‡∏õ‡∏•‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô LINE Server ‡∏™‡πà‡∏á Request ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏´‡∏•‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö

---

## 4. ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏© (Features)

### 4.1 Smart Fallback (‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô)
LINE Reply Token ‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏±‡πâ‡∏ô‡∏°‡∏≤‡∏Å (~30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ‡∏´‡∏≤‡∏Å AI ‡∏Ñ‡∏¥‡∏î‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏ô Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:
*   Worker ‡∏à‡∏∞‡∏à‡∏±‡∏ö Exception `Invalid reply token`
*   ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ **Push Message API** ‡πÅ‡∏ó‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏ï‡πà‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)

### 4.2 Rich Content Mapping
‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏á Markdown ‡∏à‡∏≤‡∏Å AI ‡πÄ‡∏õ‡πá‡∏ô LINE Components ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:
*   `![](url)` -> **Image Message**
*   `[Link](url)` -> **Button in Flex Message**

---

## ‡∏™‡∏£‡∏∏‡∏õ
‡∏£‡∏∞‡∏ö‡∏ö LINE Integration ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà Chatbot ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô **Full-Scale AI Service** ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß (Queue), ‡∏Å‡∏≤‡∏£ Retry, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Rich UI (Flex Message) ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤ Application ‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≥
